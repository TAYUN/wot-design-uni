var t=Object.defineProperty,e=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s,o=(t,e)=>{for(var a in e||(e={}))l.call(e,a)&&n(t,a,e[a]);if(s)for(var a of s(e))i.call(e,a)&&n(t,a,e[a]);return t},r=(t,s)=>e(t,a(s));import{d as u,J as c,r as d,Y as h,al as v,C as p,c as g,B as f,H as m,G as x,y,a6 as b,e as W,f as w,b as T,g as k,w as S,h as C,i as P,_ as X,E as Y,D as _,m as M,z as H,F,j,t as q,l as L,L as O,a1 as D,$ as N}from"./index-Ddr6X_C9.js";import{_ as R}from"./wd-button.C_ePM_xj.js";import{b as z,n as B,_ as E}from"./base64.DGXTDNor.js";import{u as $}from"./useTranslate.zeM_cXdJ.js";const I=r(o({},z),{penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},clearText:String,revokeText:String,restoreText:String,confirmText:String,fileType:{type:String,default:"png"},quality:{type:Number,default:1},exportScale:{type:Number,default:1},disabled:{type:Boolean,default:!1},height:B,width:B,backgroundColor:String,disableScroll:{type:Boolean,default:!0},enableHistory:{type:Boolean,default:!1},step:{type:Number,default:1},undoText:String,redoText:String,pressure:{type:Boolean,default:!1},minWidth:{type:Number,default:2},maxWidth:{type:Number,default:6},minSpeed:{type:Number,default:1.5}}),J=E(u(r(o({},{name:"wd-signature",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"}}),{props:I,emits:["start","end","signing","confirm","clear"],setup(t,{expose:e,emit:a}){const s=t,l=a,{translate:i}=$("signature"),{proxy:n}=c(),u=d(`signature${h()}`);let z=null;const B=d(!1),E=d(1),I=v({canvasWidth:0,canvasHeight:0,ctx:null});p((()=>s.penColor),(()=>{ut()})),p((()=>s.lineWidth),(()=>{ut()}));const J=g((()=>{const t={};return f(s.width)&&(t.width=m(s.width)),f(s.height)&&(t.height=m(s.height)),`${x(t)}`})),G=g((()=>s.disableScroll)),A=g((()=>s.enableHistory)),U=d([]),K=d([]),Q=d(),V=d(0);const Z=()=>s.pressure?(s.maxWidth+s.minWidth)/2:s.lineWidth,tt=t=>{t.preventDefault(),B.value=!0,ut(),l("start",t);const{x:e,y:a}=t.touches[0];Q.value={points:[{x:e,y:a,t:Date.now()}],color:s.penColor,width:Z(),backgroundColor:s.backgroundColor,isPressure:s.pressure},K.value=[],it(t)},et=t=>{t.preventDefault(),B.value=!1,Q.value&&(U.value.push(r(o({},Q.value),{points:Q.value.points.map((t=>r(o({},t),{t:t.t,speed:t.speed,distance:t.distance,lineWidth:t.lineWidth,lastX1:t.lastX1,lastY1:t.lastY1,lastX2:t.lastX2,lastY2:t.lastY2,isFirstPoint:t.isFirstPoint})))})),V.value=U.value.length),Q.value=void 0;const{ctx:e}=I;e&&e.beginPath(),l("end",t)},at=(t=!1)=>{!t&&I.canvasHeight&&I.canvasWidth||new Promise((t=>{const{ctx:e}=I;if(e)return t(e);O(`#${u.value}`,!1,n).then((e=>{var a,s;a=e.width,s=e.height,I.canvasHeight=s*E.value,I.canvasWidth=a*E.value,I.ctx=D(u.value,n),I.ctx&&I.ctx.scale(E.value,E.value),t(I.ctx)}))})).then((()=>{const{ctx:t}=I;t&&f(s.backgroundColor)&&(t.setFillStyle(s.backgroundColor),t.fillRect(0,0,I.canvasWidth,I.canvasHeight),t.draw())}))},st=()=>{U.value=[],K.value=[],V.value=0,function(){const{canvasWidth:t,canvasHeight:e,ctx:a}=I;a&&(a.clearRect(0,0,t,e),f(s.backgroundColor)&&(a.setFillStyle(s.backgroundColor),a.fillRect(0,0,t,e)),a.draw())}(),l("clear")},lt=()=>{!function(){const{fileType:t,quality:e,exportScale:a}=s,{canvasWidth:i,canvasHeight:o}=I;N({width:i*a,height:o*a,destWidth:i*a,destHeight:o*a,fileType:t,quality:e,canvasId:u.value,canvas:z,success:t=>{const e={tempFilePath:t.tempFilePath,width:i*a/E.value,height:o*a/E.value,success:!0};l("confirm",e)},fail:()=>{const t={tempFilePath:"",width:i*a/E.value,height:o*a/E.value,success:!1};l("confirm",t)}},n)}()},it=t=>{t.preventDefault();const{ctx:e}=I;if(!B.value||s.disabled||!e)return;const{x:a,y:i}=t.touches[0],n={x:a,y:i,t:Date.now()};if(Q.value){const t=Q.value.points,l=t[t.length-1];if(l.t===n.t||l.x===a&&l.y===i)return;if(n.distance=Math.sqrt(Math.pow(n.x-l.x,2)+Math.pow(n.y-l.y,2)),n.speed=n.distance/(n.t-l.t||.1),s.pressure&&(n.lineWidth=function(t){if(!s.pressure)return s.lineWidth;const e=s.minSpeed||1.5,a=Math.min(10*e,Math.max(e,t)),l=(s.maxWidth-s.minWidth)*(a-e)/e,i=Math.max(s.maxWidth-l,s.minWidth);return Math.min(i,s.maxWidth)}(n.speed),t.length>=2)){if(t[t.length-2].lineWidth&&l.lineWidth){const t=(n.lineWidth-l.lineWidth)/l.lineWidth,e=.2;if(Math.abs(t)>e){const a=t>0?e:-.2;n.lineWidth=l.lineWidth*(1+a)}}}t.push(n),s.pressure?t.length>=2&&function(t,e){const{ctx:a}=I;if(!a)return;const l=e.x-t.x,i=e.y-t.y;if(Math.sqrt(l*l+i*i)<=2)e.lastX1=e.lastX2=t.x+.5*l,e.lastY1=e.lastY2=t.y+.5*i;else{const a=e.speed||0,n=s.minSpeed||1.5,o=Math.max(.1,Math.min(.9,a/(10*n)));e.lastX1=t.x+l*(.2+.3*o),e.lastY1=t.y+i*(.2+.3*o),e.lastX2=t.x+l*(.8-.3*o),e.lastY2=t.y+i*(.8-.3*o)}const n=e.lineWidth||s.lineWidth;"number"==typeof t.lastX1?(a.setLineWidth(n),a.beginPath(),a.moveTo(t.lastX2,t.lastY2),a.quadraticCurveTo(t.x,t.y,e.lastX1,e.lastY1),a.stroke(),t.isFirstPoint||(a.beginPath(),a.moveTo(t.lastX1,t.lastY1),a.quadraticCurveTo(t.x,t.y,t.lastX2,t.lastY2),a.stroke()),a.draw(!0)):e.isFirstPoint=!0}(l,n):(e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(n.x,n.y),e.stroke(),e.draw(!0))}l("signing",t)},nt=()=>{const{ctx:t}=I;t&&(f(s.backgroundColor)?(t.setFillStyle(s.backgroundColor),t.fillRect(0,0,I.canvasWidth,I.canvasHeight)):t.clearRect(0,0,I.canvasWidth,I.canvasHeight),0!==U.value.length?(U.value.forEach((e=>{e.points.length&&(t.setStrokeStyle(e.color),t.setLineJoin("round"),t.setLineCap("round"),e.isPressure&&s.pressure?e.points.forEach(((a,l)=>{if(0===l)return;const i=e.points[l-1],n=a.x-i.x,o=a.y-i.y;if(Math.sqrt(n*n+o*o)<=2)a.lastX1=a.lastX2=i.x+.5*n,a.lastY1=a.lastY2=i.y+.5*o;else{const t=a.speed||0,e=s.minSpeed||1.5,l=Math.max(.1,Math.min(.9,t/(10*e)));a.lastX1=i.x+n*(.2+.3*l),a.lastY1=i.y+o*(.2+.3*l),a.lastX2=i.x+n*(.8-.3*l),a.lastY2=i.y+o*(.8-.3*l)}const r=a.lineWidth||e.width;"number"==typeof i.lastX1?(t.setLineWidth(r),t.beginPath(),t.moveTo(i.lastX2,i.lastY2),t.quadraticCurveTo(i.x,i.y,a.lastX1,a.lastY1),t.stroke(),i.isFirstPoint||(t.beginPath(),t.moveTo(i.lastX1,i.lastY1),t.quadraticCurveTo(i.x,i.y,i.lastX2,i.lastY2),t.stroke())):a.isFirstPoint=!0})):(t.setLineWidth(e.width),e.points.forEach(((a,s)=>{if(0===s)return;const l=e.points[s-1];t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(a.x,a.y),t.stroke()}))))})),t.draw()):t.draw())},ot=()=>{if(!U.value.length)return;const t=Math.min(s.step,U.value.length),e=U.value.splice(U.value.length-t);K.value.push(...e),V.value=Math.max(0,V.value-t),nt()},rt=()=>{if(!K.value.length)return;const t=Math.min(s.step,K.value.length),e=K.value.splice(K.value.length-t);U.value.push(...e),V.value=Math.min(U.value.length,V.value+t),nt()};function ut(){const{ctx:t}=I;t&&(t.setLineWidth(Z()),t.setStrokeStyle(s.penColor),t.setLineJoin("round"),t.setLineCap("round"))}return y((()=>{at()})),b((()=>{})),e({init:at,clear:st,confirm:lt,restore:rt,revoke:ot}),(t,e)=>{const a=X,s=P,l=W(w("wd-button"),R);return k(),T(s,{class:"wd-signature"},{default:S((()=>[C(s,{class:"wd-signature__content"},{default:S((()=>[C(a,{class:"wd-signature__content-canvas","canvas-id":u.value,style:Y(J.value),width:I.canvasWidth,height:I.canvasHeight,id:u.value,"disable-scroll":G.value,onTouchstart:tt,onTouchend:et,onTouchmove:it},null,8,["canvas-id","style","width","height","id","disable-scroll"])])),_:1}),C(s,{class:"wd-signature__footer"},{default:S((()=>[_(t.$slots,"footer",{clear:st,confirm:lt,currentStep:V.value,revoke:ot,restore:rt,canUndo:U.value.length>0,canRedo:K.value.length>0,historyList:U.value},(()=>[A.value?(k(),M(F,{key:0},[C(l,{size:"small",plain:"",onClick:ot,disabled:U.value.length<=0},{default:S((()=>[j(q(t.revokeText||L(i)("revokeText")),1)])),_:1},8,["disabled"]),C(l,{size:"small",plain:"",onClick:rt,disabled:K.value.length<=0},{default:S((()=>[j(q(t.restoreText||L(i)("restoreText")),1)])),_:1},8,["disabled"])],64)):H("",!0),C(l,{size:"small",plain:"",onClick:st},{default:S((()=>[j(q(t.clearText||L(i)("clearText")),1)])),_:1}),C(l,{size:"small",onClick:lt},{default:S((()=>[j(q(t.confirmText||L(i)("confirmText")),1)])),_:1})]),!0)])),_:3})])),_:3})}}})),[["__scopeId","data-v-24878af9"]]);export{J as _};
